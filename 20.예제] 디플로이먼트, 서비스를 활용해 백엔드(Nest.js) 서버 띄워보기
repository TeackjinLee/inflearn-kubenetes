# [예제] 디플로이먼트, 서비스를 활용해 백엔드(Nest.js) 서버 띄워보기

### ✅ 디플로이먼트, 서비스를 활용해 백엔드(Nest.js) 서버 띄워보기

<aside>

**[요구 사항]**

- 파드 4개 띄우기
- 서비스(Service)를 활용해 `http://localhost:31000`에서 통신할 수 있도록 만들기
</aside>

1. **Nest.js 프로젝트 만들기**
    
    ```bash
    # nest new {프로젝트명}
    $ nest new nest-server
    ```
    

1. **프로젝트 실행시켜보기**
    
    ```bash
    $ npm i
    $ npm run start
    ```
    
<img width="1186" height="434" alt="image" src="https://github.com/user-attachments/assets/01ecd59d-249f-441b-aa59-9090f674b545" />
    
2. **Dockerfile 작성하기**
    
    **Dockerfile**
    
    ```docker
    FROM node
    
    WORKDIR /app
    
    COPY . .
    
    RUN npm install
    
    RUN npm run build
    
    EXPOSE 3000
    
    ENTRYPOINT [ "node", "dist/main.js" ]
    ```
    
3. **.dockerignore 작성하기**
    
    **.dockerignore**
    
    ```jsx
    node_modules
    ```
    
4. **Dockerfile을 바탕으로 이미지 빌드하기**
    
    ```bash
    $ docker build -t nest-server:1.0 .
    ```
    
5. **이미지가 잘 생성됐는 지 확인하기**
    
    ```bash
    $ docker image ls
    ```
    
6. **매니페스트 파일 생성하기**
    
    **nest-deployment.yaml**
    
    ```bash
    apiVersion: apps/v1
    kind: Deployment
    
    # Deployment 기본 정보
    metadata:
      name: nest-deployment # Deployment 이름
    
    # Deployment 세부 정보
    spec:
      replicas: 4 # 생성할 파드의 복제본 개수
      selector:
        matchLabels:
          app: backend-app # 아래에서 정의한 Pod 중 'app: backend-app'이라는 값을 가진 파드를 선택
    
      # 배포할 Pod 정의
      template:
        metadata:
          labels: # 레이블 (= 카테고리)
            app: backend-app
        spec:
          containers:
            - name: nest-container # 컨테이너 이름
              image: nest-server:1.0 # 컨테이너를 생성할 때 사용할 이미지
              imagePullPolicy: IfNotPresent # 로컬에서 이미지를 먼저 가져온다. 없으면 레지스트리에서 가져온다.
              ports:
                - containerPort: 3000  # 컨테이너에서 사용하는 포트를 명시적으로 표현
    ```
    

**nest-service.yaml**

```bash
apiVersion: v1
kind: Service

# Service 기본 정보
metadata:
  name: nest-service
  
# Service 세부 정보
spec:
  type: NodePort # Service의 종류
  selector:
    app: backend-app # 실행되고 있는 파드 중 'app: backend-app'이라는 값을 가진 파드와 서비스를 연결
  ports:
    - protocol: TCP # 서비스에 접속하기 위한 프로토콜
      nodePort: 31000 # 외부에서 사용자들이 접근하게 될 포트 번호
      port: 3000 # 쿠버네티스 내부에서 Service에 접속하기 위한 포트 번호
      targetPort: 3000 # 매핑하기 위한 파드의 포트 번호
```

1. **매니페스트 파일 기반으로 오브젝트 생성**
    
    ```bash
    $ kubectl apply -f nest-deployment.yaml
    $ kubectl apply -f nest-service.yaml
    ```
    

1. **정상적으로 실행됐는 지 확인하기**
    
<img width="406" height="199" alt="image" src="https://github.com/user-attachments/assets/c5c16171-33d0-4aea-b826-95d00c6b2b41" />
    

### ✅ 업데이트 하기

<aside>

**[요구 사항]**

- 백엔드 서버 띄운 이후에 `Hello World!`라고 응답하는 서버에서 `Hi World!`라고 응답하는 서버로 업데이트 하기
</aside>

1. **Nest.js 코드 수정하기**
    
    **app.service.ts**
    
    ```
    import { Injectable } from '@nestjs/common';
    
    @Injectable()
    export class AppService {
      getHello(): string {
        return **'Hi World!'**;
      }
    }
    ```
    
2. **이미지 새로 빌드하기**
    
    ```
    $ docker build -t nest-server:**1.1** .
    ```
    
3. **매니페스트 파일 수정하기**
    
    **nest-deployment.yaml**
    
    ```
    apiVersion: apps/v1
    kind: Deployment
    
    # Deployment 기본 정보
    metadata:
      name: nest-deployment # Deployment 이름
    
    # Deployment 세부 정보
    spec:
      replicas: 4 # 생성할 파드의 복제본 개수
      selector:
        matchLabels:
          app: backend-app # 아래에서 정의한 Pod 중 'app: backend-app'이라는 값을 가진 파드를 선택
    
      # 배포할 Pod 정의
      template:
        metadata:
          labels: # 레이블 (= 카테고리)
            app: backend-app
        spec:
          containers:
            - name: nest-container # 컨테이너 이름
              image: nest-server:**1.1** # 컨테이너를 생성할 때 사용할 이미지
              imagePullPolicy: IfNotPresent # 로컬에서 이미지를 먼저 가져온다. 없으면 레지스트리에서 가져온다.
              ports:
                - containerPort: 3000  # 컨테이너에서 사용하는 포트를 명시적으로 표현
    ```
    

1. **수정된 매니페스트 파일 적용시키기**
    
    ```
    $ kubectl apply -f nest-deployment.yaml
    ```
    

1. **업데이트 됐는 지 확인하기**
    
<img width="652" height="258" alt="image" src="https://github.com/user-attachments/assets/4ab0600a-1e23-4628-89d7-02d4b827d68f" />
