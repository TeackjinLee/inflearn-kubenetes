# 보안을 위해 외부에서 MySQL 접근하지 못하도록 막기

### ✅ 기존 구성의 보안적인 문제점

<img width="2048" height="939" alt="image" src="https://github.com/user-attachments/assets/a0956388-6723-4c04-9a66-f655086c97b1" />

지금까지 만든 구조를 살펴보면 위와 같다. 위의 구조에서 MySQL을 중점적으로 살펴보면 보안에 취약한 점이 있다. `30002`번 포트로 MySQL에 직접적으로 접근할 수 있게끔 보안이 설정되어 있다는 점이다. `Service`의 `NodePort`를 활용해 `30002`번 포트를 외부로 오픈해서 MySQL에 아무나 접근할 수 있게 만들었다. 

### ✅ Service 종류 복습

- `NodePort` : 쿠버네티스 내부에서 해당 서비스에 접속하기 위한 포트를 열고 외부에서 접속 가능하도록 한다.
- `ClusterIP` : **쿠버네티스 내부에서만 통신**할 수 있는 IP 주소를 부여. **외부에서는 요청할 수 없다.**
- `LoadBalancer` : 외부의 로드밸런서(AWS의 로드밸런서 등)를 활용해 외부에서 접속할 수 있도록 연결한다.

### ✅ 보안적인 문제점 해결

보안적인 문제점 해결을 위해 `Service`의 종류 중 `NodePort`를 사용하지 않고 `ClusterIP`를 활용해야 한다. `ClusterIP`를 활용함으로써 외부에서 아무나 MySQL에 접근하지 못하게 막아야 한다. 

1. **기존 Service 매니페스트 파일 수정하기**
    
    **mysql-service.yaml**
    
    ```bash
    apiVersion: v1
    kind: Service
    
    # Service 기본 정보
    metadata:
      name: mysql-service # Service 이름
    
    # Service 세부 정보
    spec:
      type: **ClusterIP** # Service의 종류
      selector:
        app: mysql-db # 실행되고 있는 파드 중 'app: mysql-db'이라는 값을 가진 파드와 서비스를 연결
      ports:
        - protocol: TCP # 서비스에 접속하기 위한 프로토콜
          port: 3306 # 쿠버네티스 내부에서 Service에 접속하기 위한 포트 번호
          targetPort: 3306 # 매핑하기 위한 파드의 포트 번호
          **~~nodePort: 30002** # 외부에서 사용자들이 접근하게 될 포트 번호~~
    ```
    
2. **기존 Service 중단하면 작동 안 하는 지 먼저 확인하기**
    
    ```bash
    $ kubectl delete service mysql-service
    $ kubectl rollout restart deployment spring-deployment
    ```
    
<img width="762" height="514" alt="image" src="https://github.com/user-attachments/assets/7a1649dc-005c-4ee1-9229-08379b69d635" />
    
3. **Service 작동시키기**
    
    ```bash
    $ kubectl apply -f mysql-service.yaml
    $ kubectl rollout restart deployment spring-deployment
    ```
    

1. **Spring Boot 서버와 잘 연결됐는 지 확인**
    
<img width="322" height="117" alt="image" src="https://github.com/user-attachments/assets/90b20723-dd87-44c5-9e71-dba5258cd72e" />
    

1. **원래 접속하던 DB에 접속이 안 되는 지 확인**
    
<img width="1592" height="1356" alt="image" src="https://github.com/user-attachments/assets/8652876f-bee7-4ef4-a5ff-6e231f74a7b6" />
    

### ✅ 그림으로 이해하기

<img width="2048" height="965" alt="image" src="https://github.com/user-attachments/assets/cca71445-504b-4898-aebb-4da384d29b22" />

### ✅ DB를 관리하기 위해 접속해야 할 때는?

쿠버네티스의 포트 포워딩을 활용해서 접속하면 된다. 아래 포트 포워딩 명령어를 사용하면 내 로컬 컴퓨터에서만 해당 파드와 연결을 허용시킬 수 있게 된다. 

```bash
$ kubectl port-forward pod/[MySQL 파드명] 3306:3306
```

<img width="1608" height="1368" alt="image" src="https://github.com/user-attachments/assets/eeca3a18-b21b-4672-819a-dd309754703a" />
