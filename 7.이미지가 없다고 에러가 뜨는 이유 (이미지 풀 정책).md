# 이미지가 없다고 에러가 뜨는 이유 (이미지 풀 정책)

### ✅ 이미지가 없다고 에러가 뜨는 이유

이전에 Spring Boot 프로젝트를 이미지로 빌드해서 파드로 띄웠다. 하지만 ImagePullBackOff라는 에러가 발생했다. 이 문제는 **이미지 풀 정책(Image Pull Policy)** 때문에 발생한 것이다. 이미지 풀 정책이 뭔지 알아보자. 

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/e35a8144-c5ff-40f0-b123-384a331e35bb/ca145a29-0902-4470-9cf0-81b8cb71edd0/image.png)

### ✅ 이미지 풀 정책 (Image Pull Policy)

이미지 풀 정책(Image Pull Policy)이란 쿠버네티스가 yaml 파일을 읽어들여 파드를 생성할 때, 이미지를 어떻게 Pull을 받아올 건지에 대한 정책을 의미한다. 어떤 정책들이 있는 지 알아보자. 

1. **`Always`**
    
    로컬에서 이미지를 가져오지 않고, 무조건 **레지스트리(= Dockerhub, ECR과 같은 원격 이미지 저장소)에서 가져온다.** 
    
2. **`IfNotPresent`**
    
    로컬에서 이미지를 먼저 가져온다. 만약 로컬에 이미지가 없는 경우에만 레지스트리에서 가져온다. 
    
3. **`Never`**
    
    로컬에서만 이미지를 가져온다. 
    

### ✅ 매니페스트 파일에 이미지 풀 정책 설정하는 방법

```bash
apiVersion: v1
kind: Pod
metadata:
  name: spring-pod
spec:
  containers:
    - name: spring-container
      image: spring-server
      ports:
        - containerPort: 8080
      **imagePullPolicy: Always**
```

### ✅ 기존 매니페스트 파일 다시 살펴보기

**spring-pod.yaml**

```bash
apiVersion: v1
kind: Pod
metadata:
  name: spring-pod
spec:
  containers:
    - name: spring-container
      image: spring-server
      ports:
        - containerPort: 8080
```

위의 매니페스트 파일에서는 이미지 풀 정책을 따로 설정하지 않았다. 이럴 때는 아래와 같이 작동한다. 

- 이미지의 태그가 `latest`이거나 명시되지 않은 경우 : `imagePullPolicy`는 `Always`로 설정됨
- 이미지의 태그가 `latest`가 아닌 경우 : `imagePullPolicy`는 `IfNotPresent`로 설정됨

따라서 기존 매니페스트 파일은 `imagePullPolicy`가 `Always`로 작동했던 것이다. 즉, 로컬에서 이미지를 가져오지 않고 레지스트리에서 가져오려고 했다. 하지만 `spring-server`라는 이미지는 Dockerhub에 올린 적이 없기 때문에 이미지를 못 받아온 것이다. 따라서 아래와 같이 에러가 떴다. 

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/e35a8144-c5ff-40f0-b123-384a331e35bb/ca145a29-0902-4470-9cf0-81b8cb71edd0/image.png)

> 그러면 어떻게 해야 로컬에 있는 이미지를 가져올 수 있을까?
> 

**spring-pod.yaml**

```bash
apiVersion: v1
kind: Pod
metadata:
  name: spring-pod
spec:
  containers:
    - name: spring-container
      image: spring-server
      ports:
        - containerPort: 8080
      **imagePullPolicy: IfNotPresent**
```

위와 같이 정책을 설정해주어야 로컬에서 이미지를 가져오게 된다. 

기존 파드를 삭제하고 다시 생성해보자. 

```bash
$ kubectl delete pod spring-pod
$ kubectl apply -f spring-pod.yaml
$ kubectl get pods
```

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/e35a8144-c5ff-40f0-b123-384a331e35bb/f0e4507a-fa17-43bc-80ab-71de300457f9/image.png)

Spring Boot 서버에 요청을 보내서 잘 응답하는 지도 알아보자. 

**방법 1. 파드 내부로 들어가서 요청보내기**

```bash
$ kubectl exec -it spring-pod -- bash 
$ curl localhost:8080
```

**방법 2. 포트 포워딩 활용하기**

```bash
# 포트
$ kubectl port-forward pod/spring-pod 12345:8080 
```

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/e35a8144-c5ff-40f0-b123-384a331e35bb/288d6a92-4c4f-4a03-8532-a4a7933ecc6d/image.png)

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/e35a8144-c5ff-40f0-b123-384a331e35bb/3f4fe252-116a-420b-8019-7ca8c153d66b/image.png)

### ✅ 파드 삭제하기

```bash
$ kubectl delete pod spring-pod
```
